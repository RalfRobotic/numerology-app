<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DEBUG MODE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #fff; color: #000; }
        .btn { 
            display: block; width: 100%; padding: 20px; margin: 20px 0; 
            background: blue; color: white; font-size: 20px; font-weight: bold; 
            border: none; border-radius: 10px; 
        }
        input { font-size: 20px; padding: 10px; width: 100%; box-sizing: border-box; }
        .error { color: red; font-weight: bold; border: 1px solid red; padding: 10px; display: none;}
    </style>
</head>
<body>

    <h1>üîß –†–ï–ñ–ò–ú –û–¢–õ–ê–î–ö–ò</h1>
    <div id="status" style="color: grey;">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    <div id="err-box" class="error"></div>

    <p>1. –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É:</p>
    <input type="date" id="date-input">

    <p>2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É:</p>
    <button class="btn" onclick="startSending()">üöÄ –û–¢–ü–†–ê–í–ò–¢–¨</button>

    <script>
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫ JS
        window.onerror = function(msg, url, line) {
            alert("üî• GLOBAL ERROR: " + msg + "\nLine: " + line);
            document.getElementById('err-box').style.display = 'block';
            document.getElementById('err-box').innerText = "JS Error: " + msg;
        };

        const tg = window.Telegram.WebApp;
        const statusEl = document.getElementById('status');

        try {
            tg.expand();
            statusEl.innerText = "TG SDK –∑–∞–≥—Ä—É–∂–µ–Ω. InitData length: " + tg.initData.length;
        } catch (e) {
            statusEl.innerText = "–û—à–∏–±–∫–∞ SDK: " + e.message;
            alert("–û—à–∏–±–∫–∞ Telegram SDK: " + e.message);
        }

        function startSending() {
            try {
                alert("1. –ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞. –ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö...");

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã
                const dateVal = document.getElementById('date-input').value;
                if (!dateVal) {
                    alert("‚ùå –û—à–∏–±–∫–∞: –î–∞—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞!");
                    return;
                }
                alert("2. –î–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞: " + dateVal);

                // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
                const data = {
                    action: 'full_analysis',
                    date: dateVal.split('-').reverse().join('.'),
                    name: "Debug User"
                };
                const jsonStr = JSON.stringify(data);
                alert("3. JSON –≥–æ—Ç–æ–≤: " + jsonStr);

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ sendData
                if (!tg.initData) {
                    throw new Error("initData –ø—É—Å—Ç–∞—è! –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –º–µ–Ω—é/–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.");
                }

                alert("4. –í—ã–∑—ã–≤–∞—é tg.sendData(). –û–∫–Ω–æ –¥–æ–ª–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å—Å—è...");
                
                // === –ì–õ–ê–í–ù–´–ô –ú–û–ú–ï–ù–¢ ===
                tg.sendData(jsonStr);
                
                // –ï—Å–ª–∏ –º—ã —É–≤–∏–¥–∏–º —ç—Ç–æ—Ç –∞–ª–µ—Ä—Ç, –∑–Ω–∞—á–∏—Ç –æ–∫–Ω–æ –ù–ï –∑–∞–∫—Ä—ã–ª–æ—Å—å
                alert("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: tg.sendData –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å, –Ω–æ –æ–∫–Ω–æ –Ω–µ –∑–∞–∫—Ä—ã–ª–æ—Å—å. –≠—Ç–æ –±–∞–≥ Telegram –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π —Å–ø–æ—Å–æ–± –æ—Ç–∫—Ä—ã—Ç–∏—è.");

            } catch (e) {
                alert("üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –í–ù–£–¢–†–ò –§–£–ù–ö–¶–ò–ò: " + e.message);
                document.getElementById('err-box').style.display = 'block';
                document.getElementById('err-box').innerText = e.message;
            }
        }
    </script>
</body>
</html>
